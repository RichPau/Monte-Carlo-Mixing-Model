---
title: "Deterministic Monte Carlo Mixing Model of Regional Groundwater Salinization"
author: "Rich Pauloo"
date: "7/4/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##### All scripts, versions, data input files, and documentation for this model can be found in [this Github repository.](https://github.com/RichPau/Monte-Carlo-Mixing-Model)

## Set working directory and load data [^1]
##### C2VSim Groundwater, Land, and Root Zone Budgets are for the 40 year period from 10/31/1961-9/30/2001. [@Brush2013].
```{r set working directory and load data, warning = F, message = F}
# Groundwater budget (10/31/1961-9/30/2001)
GW = read.csv(file = "data/GW.csv", stringsAsFactors = FALSE, header = TRUE) 

# Land Budget budget (10/31/1961-9/30/2001)
LB = read.csv(file = "data/LB.csv", stringsAsFactors = FALSE, header = TRUE)

# Root Zone budget (10/31/1961-9/30/2001)
RZ = read.csv(file = "data/RZ.csv", stringsAsFactors = FALSE, header = TRUE) 

# Bring in boundary condition data and RWI from dissertation/code/02_reanalyze_gw_tds.R 
library(dplyr)
boundary_dat <- readRDS("data/boundary_dat.rds")
bd <- boundary_dat %>% dplyr::select(x,y) %>% 
  mutate(x = abs(x) * 3.28084) %>% # convert m to ft for model
  arrange(x) %>% 
  as.matrix()

# read in RWI
# rwi_dat <- readRDS("data/rwi.rds") * -1 * 3.28084
```
[^1]: Original C2VSim model files (R374) can be found at: <http://baydeltaoffice.water.ca.gov/modeling/hydrology/C2VSim/index_C2VSIM.cfm>

## Load Required Packages [^2]
```{r load packages, warning = F, message = F}
library(extrafont)
library(scales)
library(ggplot2)
library(grid)
library(gridExtra)
```
[^2]: if these packages are not already installed, use the function ```install.packages()``` to install the necessary packages

## Define Common Unit Conversion Functions
```{r Unit Conversion Functions, warning = F, message = F}
# converts acre-feet to liters
af_to_L = function(a){
  a * 43560 * 28.3168
}

# converts miligrams to million tons
mg_to_Mton = function(a){
  a / (1000*907185*1000000)
}
```

## Define Boundary Conditions 
##### Rock Water Interaction Coefficients dervied from groundwater salinity literature of the Tulare Basin [@Kang2016; @Williamson1989]. 
##### Groundwater velocity was computed with Z Budget and the C2VSim model, Version 3.02-CG (R374) [@Brush2013].

```{r boundary conditions, warning = F, message = F}
# Rock water interactions
Kang       = 3000/mean(c(1719,2205)) # (Kang, 2016) 3000 mg/L at 1719 ft. in Fresno co., 2205 ft. in Kern co.
Williamson = 2000/2500


# velocity field from C2VSim
dv12 = 0.76106 # Darcy velocity between centroids of layers 1-2 (ft/yr)
dv23 = -0.01772 # Darcy velocity between centroids of layers 2-3 (ft/yr)

# C2VSim Groundwater budget (units = AF)
DP     = sum(GW$DP) # deep percolation
Si     = sum(GW$Si) # beginning storage
Sf     = sum(GW$Sf) # ending storage
NDP    = sum(GW$NDP) # net deep percolation
Stream = sum(GW$Stream) # stream gain
R      = sum(GW$R) # recharge
Lake   = sum(GW$Lake) # lake gain
BI     = sum(GW$BI) # sum(GW$Si) boundary inflow
Sub    = sum(GW$Sub) # subsidence flow
P      = sum(GW$P) # GW pumping
SI     = sum(GW$Net.Subsurface.Inflow....) # subsurface inflow

# spatial/temporal dimensions
Dim = data.frame(subregion = seq(14,21,1), 
                 SA = c(670228.87, 904472.46, 302449.08, 372889.22, 
                        897090.81, 801419.62, 423713.29, 652847.11), # acre feet
                 thickness = c(1915.155, 1990.01, 1509.194, 1868.821, 
                               1904.244, 1715.117, 1969.524, 3244.262)) # feet: from C2VSim model

Tot_SA         = sum(Dim$SA) # total surface area (acres)
V              = Dim$SA * Dim$thickness # Volume (AF)
Tot_V          = af_to_L(sum(V)) # total volume (L)
SA_w_thickness = sum(Dim$SA/Tot_SA*Dim$thickness) # surface area weighted thickness

# time step length
t = 50 # years

# length of C2VSim simulation
l = 40 # years


####################################################################################
# salt concentration of natural SW and thus GWW from (Cismowski, 2006)
# within report search for: Annual Salt Load (thousand tons/year)
####################################################################################
sw <- data.frame(term = c("sac","yolo","sjr"),
                 ttons = c(1945, 405,922),
                 taf_yr = c(16953,2980,3082))

# concentration of delivered sw
sw$c <- sw$ttons / sw$taf_yr
sw$c <- sw$c * 9.072e+11 / 1.233e+9 # convert ktons to mg and thousand acre feet to L

# volume weighted concetration
sw <- sw %>% 
  mutate(pv  = taf_yr / (sum(sw$taf_yr)), # percent volume
         vwc = pv * c) # volume weighted concentration
# sum(sw$vwc) # final concentration of surface water input

# volume weighted concetration
sw <- sw %>% 
  mutate(pv  = taf_yr / (sum(sw$taf_yr)), # percent volume
         vwc = pv * c) # volume weighted concentration
gwc <- sum(sw$vwc) # final concentration of natural surface water and thus GW
####################################################################################

# C2VSim average annual fluxes from GW budget
annual_fluxes = data.frame(term = c("NDP", "Stream", "R", "Lake", "BI", "Sub", "P", "SI"),
                           "L/yr" = c(af_to_L(NDP/l), af_to_L(Stream/l), af_to_L(R/l), 
                                      af_to_L(Lake/l), af_to_L(BI/l), af_to_L(Sub/l), 
                                      af_to_L(P/l), af_to_L(SI/l)))
annual_fluxes$TDS = c(0,gwc,gwc,gwc,gwc,gwc,0,gwc) # TDS
annual_fluxes$mass_flux = annual_fluxes$L.yr * annual_fluxes$TDS # mass flux (mg/yr)

# Internal mass flux
internal_mf = (annual_fluxes[5,4] + annual_fluxes[6,4] + annual_fluxes[8,4])*t # mg/50 yr 

# Top down Mass Flux
top_mf = (annual_fluxes[2,4] + annual_fluxes[3,4] + annual_fluxes[4,4])*t # mg/50 yr 

# Root Zone Budget (includes Agriculture, Urban, and Native Vegetation)
I  = sum(RZ$AG_INF) + sum(RZ$URB_INF) + sum(RZ$NAT_INF) # Net infiltration
ET = sum(RZ$AG_ET) + sum(RZ$URB_ET) + sum(RZ$NAT_ET) # Net ET

# Percentages
pI   = NDP/I # percentage of infiltration that becomes NDP
pGWP = P/I # Percentage of groundwater pumping in Total Applied Water
pSW  = 1 - pGWP # percentage of surface water diversions and reuse in Total Applied Water

# Average Annual Surface Water TDS, volume, and mass flux
# TDS_SW = .38*((247.22540+254.26799)/2) + .62*(87.24187) # TDS of surface water

####################################################################################
# salt concentration of SW imports from (Cismowski, 2006)
# within report search for: Annual Salt Load (thousand tons/year)
####################################################################################

# period of record 1985 - 1994
sw <- data.frame(term = c("swp","cvp"),
                 ttons = c(1004, 900),
                 taf_yr = c(2471,2328))

# concentration of delivered sw
sw$c <- sw$ttons / sw$taf_yr
sw$c <- sw$c * 9.072e+11 / 1.233e+9 # convert ktons to mg and thousand acre feet to L

# volume weighted concetration
sw <- sw %>% 
  mutate(pv  = taf_yr / (sum(sw$taf_yr)), # percent volume
         vwc = pv * c) # volume weighted concentration
TDS_SW <- sum(sw$vwc) # final concentration of surface water input
####################################################################################

V_SW = (I - P) / l # Average Annual SW diversion volume (AF/yr)
SW_annual_mass = mg_to_Mton(af_to_L(V_SW) * TDS_SW) # Mton
```

## Number of Monte Carlo Samples
###### This number determines how many random samples are drawn from the input parameters modeled as distributions of a random variable. 1000 samples is standard.
```{r Number of Monte Carlo Samples, warning = F, message = F}
N = 1000
```

## Initialize 3D output arrays 
```{r Initialize 3D output arrays, warning = F, message = F}
TDS                  = array(0, dim=c(8,8,N)) # TDS array
layer_depths_array   = array(0, dim=c(8,1,N)) # layer depths array
layer_velocity_array = array(0, dim=c(8,1,N)) # layer velocity array
mass                 = array(0, dim=c(8,1,N)) # array of sum of masses per time step
TDS_GWP              = array(0, dim=c(8,1,N)) # array of TDS of pumped groundwater per time step
TDS_AW               = array(0, dim=c(8,1,N)) # array of TDS of applied water (SW+GW) per time step
EC                   = array(0, dim=c(8,1,N)) # array of evaporative concentration of NDP per time step (TDS)
NDP_mf               = array(0, dim=c(8,1,N)) # array of NDP mass flux per time step (mg/yr)
RWI_cont             = array(0, dim=c(8,1,N)) # array of Rock water interactions
lay_vol              = array(0, dim=c(8,1,N)) # array of layer volumes
```

## Compute all output  
```{r Compute all Output, warning = F, message = F}
set.seed(23545) # ensure replicability

for(k in 1:N){

  # Random Variables
  n    = runif(1, min = 0.25, max = 0.35) # porosity
  pa   = runif(1, min = 0.35, max = 0.50) # percent aquifer
  aVol = Tot_V * n * pa # saturated aquifer volume (L)
  RWI  = runif(1, min = Williamson, max = Kang)  # Rock water interactions (TDS/ft)

  
  # velocity field from C2VSim
  v12    = 0.76106/n # linear pore velocity between centroids of layers 1-2 (ft/yr)
  v23    = -0.01772/n # linear pore velocity between centroids of layers 2-3 (ft/yr)
  vel    = c(v12,v23) # vector of velocities
  depths = c(-631.5,-2077) # C2VSim midpoints between layer centroids over which velcoity is calculated
  vel    = as.data.frame(cbind(vel,depths)) # bind vel and depth vectors into one data frame for analysis
  lm     = lm(vel$depths~vel$vel) # create a linear model between velocity and depth
  
  # vertical velocity profile
  v    = matrix(0,8,1) # initalize vector to hold computed velocities at various depths
  b    = matrix(0,8,1) # initalize vector to hold layer thicknesses, computed from groundwater velocity
  v[1] = (0 + -coef(lm)[[1]]) / coef(lm)[[2]] # compute first velocity
  b[1] = -(v[1] * t) # compute first layer thickness
  
  # compute all remaining layer velocities and thicknesses
  for(i in 1:7){
    v[i+1] = (sum(b) -coef(lm)[[1]]) / coef(lm)[[2]]
    b[i+1] = -(v[i+1] * t)
  }
  
  # Vertical Flux per layer (L/yr)
  Q = v * n * pa * Tot_SA * 43560 * 28.3168 # L/yr
  layer_fluxes = cbind(v, Q) # units of "ft/yr" and "L/yr" respectively
  
  # layer thickness (ft)
  b[8] = -(SA_w_thickness + sum(b[1:7]))
  pb   = abs(b)/SA_w_thickness # percentage of total thickness per layer
  
  # layer volumes (L)
  lay_vol[,1,k] = aVol * pb # saturated volume of all layers (L)
  

  
  # Calculate Pumping in each layer
  lay_pump = matrix(0,8,1)
  for(i in 1:7){
    lay_pump[i,1] = b[i]/sum(b) * annual_fluxes[7,2] # proportion pumping from each layer (L/yr)
  }
  

  
  # Calculate the layer depths
  layer_depths    = matrix(0,8)
  layer_depths[1] = abs(b[1])
  for(i in 2:8){
    layer_depths[i,1] = abs(layer_depths[i-1,1]) + abs(b[i]) # vector of layer depths (ft)
  }
  

  
  # Initalize TDS array with baseline TDS
  #t0 = layer_depths * RWI # inital TDS-depth profile from RWI
  
  bc_match <- matrix(0, nrow = 8, ncol = 1)
  for(i in 1:nrow(layer_depths)){
    temp  <- layer_depths[i,1] - bd[,1]
    index <- which.min(abs(temp))
    bc_match[i] = bd[index,2]
  }
  
  t0 = bc_match
  TDS[,1,k] = t0
  
  # RWI == FALSE 
  RWI_cont[,1,k] = 0
  
  # # RWI == TRUE
  # # Initalize TDS array with baseline TDS
  #TDS[,1,k] = layer_depths # inital TDS-depth profile
  #RWI_cont[,1,k] = layer_depths * RWI # add RWI cont

  
  # Record layer depth/velocity for all simulations
  layer_depths_array[,,k]   = layer_depths
  layer_velocity_array[,,k] = v
  

  
  # Compute TDS for all layers and times
  for(j in 1:7){
    
    # calculate mass flux of NDP
    mass[j,1,k]    = sum(TDS[1:7,j,k] * lay_vol[1:7,1,k]) # sum of mass in pumping layers 1-7 (mg)
    TDS_GWP[j,1,k] = mass[j,1,k]/sum(lay_vol[1:7,1,k]) # TDS of pumped GW
    TDS_AW[j,1,k]  = TDS_GWP[j,1,k] * pGWP + TDS_SW * pSW # TDS of applied water for irrigation
    EC[j,1,k]      = TDS_AW[j,1,k] * (1/pI) # TDS of NDP Evaporative concentration
    NDP_mf[j,1,k]  = EC[j,1,k] * annual_fluxes[1,2] # mass flux of NDP
    
    # TDS in layer 1
    TDS[1,j+1,k] = ((TDS[1,j,k]*lay_vol[1,1,k] + top_mf + NDP_mf[j,1,k]*t - TDS[1,j,k]*layer_fluxes[2,2]*t - 
                     TDS[1,j,k]*lay_pump[1,1]*t + internal_mf*pb[1]) / lay_vol[1,1,k]) + RWI_cont[1,1,k]
    
    # TDS in layers 2-7
    for(i in 2:7){
      TDS[i,j+1,k] = ((TDS[i,j,k]*lay_vol[i,1,k] + internal_mf*pb[i] + TDS[i-1,j,k]*layer_fluxes[i,2]*t -
                       TDS[i,j,k]*lay_pump[i,1]*t - TDS[i,j,k]*layer_fluxes[i+1,2]*t) / lay_vol[i,1,k]) + 
        RWI_cont[i,1,k]
    }
  }
}
```

## Plot 1: time, layer depth, TDS, simulation df
```{r}
# gather appraoch 
library(tidyr)

# make depth-time array
ld   <- lapply(1:1000, function(x){return(layer_depths_array[1:7,,x])}) # all layer depths in a list
td   <- lapply(1:1000, function(x){return(TDS[1:7,,x])}) # tds as a list of matrices
ldtd <- lapply(1:1000, function(x){return(data.frame(cbind(ld[[x]], td[[x]])))}) # bind

for(i in 1:1000){
  colnames(ldtd[[i]]) <- c("d", "0", "50","100","150","200","250","300","350")
  ldtd[[i]] <- gather(ldtd[[i]], time, tds, -d) # wide to long
  ldtd[[i]]$sim <- i # add simulation
}

df <- bind_rows(ldtd)
df$sim <- as.factor(df$sim)
df$time <- factor(paste0("t = ", df$time), 
                  levels = paste0("t = ", 
                                  c("0", "50","100","150","200","250","300","350")))
df$d <- df$d * 0.3048       # ft to meters

ll <- c(
  't = 0'  ="t = 0 yrs (1960)",
  't = 50' ="t = 50 yrs (2010)",
  't = 100'="t = 100 yrs (2060)",
  't = 150'="t = 150 yrs (2110)",
  't = 200'="t = 200 yrs (2160)",
  't = 250'="t = 250 yrs (2210)",
  't = 300'="t = 300 yrs (2260)",
  't = 350'="t = 350 yrs (2310)"
)



p <- df %>% filter(time %in% c("t = 0", "t = 50", "t = 100", "t = 200", "t = 250", "t = 350") & sim %in% 251:500) %>% 
  ggplot(aes(-d, tds)) + 
  geom_line(aes(color = sim), alpha = 0.2) +
  geom_smooth(se = FALSE, color = "red") + 
  coord_flip(ylim = c(0, 28000)) +
  scale_color_grey() + 
  guides(color = FALSE) + 
  theme_minimal() + 
  facet_wrap(~time, labeller = as_labeller(ll)) +
  scale_y_continuous(breaks = c(1000, 10000, 25000), labels = c('1,000', '10,000', '25,000')) + 
  labs(x = "Depth (m)", y = "TDS (mg/L)")

p

# ggsave(p, filename = "results/p_sim.pdf", device = cairo_pdf, height = 5, width = 7)
```

# Combine RWI and no RWI
```{r}
df1 <- df # RWI
df2 <- filter(df, time != "t = 0") # no RWI: second run
df1$rwi <- "RWI"; df2$rwi <- "no RWI"

df3 <- bind_rows(df1, df2) %>% mutate(sim2 = paste0(as.character(sim), "_", rwi))

p <- df3 %>% filter(time %in% c("t = 0", "t = 50", "t = 100", "t = 200", "t = 250", "t = 300") & sim %in% 251:500) %>% 
    ggplot(aes(-d, tds)) + 
    geom_line(aes(-d, tds,color = sim2), alpha = 0.2) + 
    geom_smooth(data = filter(df1, 
                              time %in% c("t = 0", "t = 50", "t = 100", "t = 200", "t = 250", "t = 300") & 
                                  sim %in% 1:1000 & d >= 60), # capture overall trend
                aes(-d, tds), 
                color = "#440154ff", 
                se = FALSE) +
    geom_smooth(data = filter(df2, 
                              time %in% c("t = 0", "t = 50", "t = 100", "t = 200", "t = 250", "t = 300") & 
                                  sim %in% 1:1000 & d >= 60), # capture overall trend
                aes(-d, tds), 
                color = "#21908dff", 
                se = FALSE) +
    geom_hline(yintercept = 1000, linetype = "dashed") +
    scale_color_grey() + 
    guides(color = FALSE) + 
    coord_flip(ylim = c(0, 21000)) + 
    theme_minimal() + 
    facet_wrap(~time, labeller = as_labeller(ll)) +
    scale_y_continuous(breaks = c(0, 5000, 10000, 15000, 20000), 
                       labels = c('0', '5,000', '10,000', '15,000', '20,000')) + 
    labs(x = "Depth (m)", y = "TDS (mg/L)")  +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.minor = element_blank())

ggsave(p, filename = "results/p_sim_both.pdf", device = cairo_pdf, height = 5, width = 7)
```


## Plot 2: Compare concentrations of GW, TAW, NDP
```{r Plot 2: Compare concentrations of GW, TAW, NDP}
# initalize matricies
GWP_mean = as.data.frame(matrix(0,7,1))
AW_mean = as.data.frame(matrix(0,7,1))
EC_mean = as.data.frame(matrix(0,7,1))
EC_median = as.data.frame(matrix(0,7,1))
GWP_5 = as.data.frame(matrix(0,7,1))
AW_5 = as.data.frame(matrix(0,7,1))
EC_5 = as.data.frame(matrix(0,7,1))
GWP_95 = as.data.frame(matrix(0,7,1))
AW_95 = as.data.frame(matrix(0,7,1))
EC_95 = as.data.frame(matrix(0,7,1))
for(i in 1:7){
  GWP_mean[i,1] = mean(TDS_GWP[i,1,])
  AW_mean[i,1] = mean(TDS_AW[i,1,])
  EC_mean[i,1] = mean(EC[i,1,])
  EC_median[i,1] = median(EC[i,1,])
  GWP_5[i,1] = quantile(TDS_GWP[i,1,], c(0.05))
  GWP_95[i,1] = quantile(TDS_GWP[i,1,], c(0.95))
  AW_5[i,1] = quantile(TDS_AW[i,1,], c(0.05))
  AW_95[i,1] = quantile(TDS_AW[i,1,], c(0.95))
  EC_5[i,1] = quantile(EC[i,1,], c(0.05))
  EC_95[i,1] = quantile(EC[i,1,], c(0.95))
}

## compile stats for TDS of pumped GW, Total Applied Water (GW+SW), and Evaporative concentration of NDP

# no RWI
EC_dat_nrwi = data.frame("legend"=rep(c("A","B","C"), each=7),
                    "time" = factor(seq(0,300,50)),
                    "mean" = rbind(GWP_mean, AW_mean, EC_median),
                    "p5" = rbind(GWP_5, AW_5, EC_5),
                    "p95" = rbind(GWP_95, AW_95, EC_95))
colnames(EC_dat_nrwi) = c("legend","time","mean","p5", "p95")
EC_dat_nrwi$class <- "No rock-water interactions"

# RWI: rerun with RWI
EC_dat_rwi = data.frame("legend"=rep(c("A","B","C"), each=7),
                    "time" = factor(seq(0,300,50)),
                    "mean" = rbind(GWP_mean, AW_mean, EC_median),
                    "p5" = rbind(GWP_5, AW_5, EC_5),
                    "p95" = rbind(GWP_95, AW_95, EC_95))
colnames(EC_dat_rwi) = c("legend","time","mean","p5", "p95")
EC_dat_rwi$class <- "Rock-water interactions present"

# combine
EC_dat2 <- bind_rows(EC_dat_nrwi, EC_dat_rwi)

# plot
p2 <- ggplot(filter(EC_dat2, time %in% c(0,50,100,150)), aes(x=time, y=mean, fill=legend)) +
  geom_bar(position=position_dodge(), stat="identity", 
           colour = "black", size=.3,
           alpha = 0.7) +
  geom_errorbar(aes(ymin=p5, ymax=p95),
                size=.3,    # thinner lines
                width=.2,                    # Width of the error bars
                position=position_dodge(.9)) +
  xlab("Time (yrs)") +
  ylab("TDS (mg/L)") +
  scale_y_continuous(labels = comma) +
  scale_fill_viridis_d(name="Source",
                 breaks=c("A","B","C"),
                 labels=c("Pumped Groundwater", 
                          "Total Applied Water", 
                          "Net Deep Percolation")) +
  theme_minimal(base_size = 13) +
  theme(legend.position = c(0.18, 0.75), panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "white", color = "transparent")) +
  facet_wrap(~class, ncol = 2)

# save
ggsave("results/p_ec.pdf", p2, height= 4, width = 7, device = cairo_pdf)
```



# Plot 3: Salt Budget for Water Budget terms and NDP
```{r}
Mtons_to_metric_tons <- function(x){return(x * 907184.74)}

## non:constant mass: extract all GW pumping TDS and convert to mass
gwp <- vector("list", length = 7)

for(i in 1:7){
  gwp[[i]] <- data.frame(TDS_GWP[i, 1, ], t = i, type = "GWP")
}

gwp <- dplyr::bind_rows(gwp)
colnames(gwp) <- c("c","t", "type")
gwp <- gwp %>% 
  mutate(m = Mtons_to_metric_tons(mg_to_Mton(c * annual_fluxes[7,2])))

# constant mass: surface water and allother budget terms

# surface water
swm <- Mtons_to_metric_tons(SW_annual_mass)

# all other budget terms
all_else <- Mtons_to_metric_tons(mg_to_Mton(sum(annual_fluxes[c(2,3,4,5,6,8),4])))

# combine into one df
df1 <- data.frame(m = rep(c(swm, all_else), each = 7), 
                  t = rep(1:7, times = 2), 
                  type = rep(c("surface_water_import", "all_else"), each = 7)) 
df2 <- select(gwp, m, t, type) 
df2 <- df2 %>% 
  group_by(t) %>% 
  summarise(median = median(m), p5 = quantile(m, 0.05), p95 = quantile(m, 0.95))

df1$p5  <- NA
df1$p95 <- NA
df2 <- df2 %>% rename(m = median) %>% mutate(type = "gwp") %>% select(m, t, type, p5, p95)

# rwi: need to go back and re-run code with RWI
mg_to_metric_tons <- function(x){return(x * 1e-9)}
RWI_int <- mg_to_metric_tons(colSums((RWI_cont[1:7,1,]*lay_vol[1:7,1,])/50)) %>% 
  quantile(c(0.05, 0.5, 0.95))
df3 <- data.frame(m = RWI_int[2], t = 1:7, type = "rwi", p5 = RWI_int[1], p95 = RWI_int[3])

df4 <- rbind.data.frame(df1, df2, df3)
df4$t <- rep(seq(0,300, 50), times = 4) # format times
df4$type <- factor(rep(c("Surface Water Diversions", "I, C, W, R, L, B", "Pumped Groundwater", "Rock-water Interactions"), each = 7), # format labels
                   levels = c("I, C, W, R, L, B", "Surface Water Diversions", "Pumped Groundwater","Rock-water Interactions"))

# RWI
df4_rwi <- df4
df4_rwi$class <- "Rock-water interactions present"

# no RWI: re-run without RWI
df4_nrwi <- df4 #%>% filter(m != 0)
df4_nrwi$class <- "No rock-water interactions"

# bind
df5 <- bind_rows(df4_rwi, df4_nrwi)

# plot
p3 <- ggplot(filter(df5, t %in% c(0,50,100,150)), aes(factor(t), m/1000000, fill = type)) + # convert m from tons to Mtons
  geom_bar(position = position_dodge(), stat = "identity", 
           colour = "black", size=.3,
           alpha = 0.7) +
  geom_errorbar(aes(ymin = p5/1000000, ymax = p95/1000000),
                size=.3,    # thinner lines
                width=.2,   # Width of the error bars
                position=position_dodge(.9)) +
  scale_fill_viridis_d("Source", option = "E") +
  theme_minimal(base_size = 13) +
  theme(legend.position = c(0.20, 0.75), panel.grid.minor = element_blank(),
        legend.background = element_rect(fill = "white", color = "transparent")) +
  #theme(legend.position = "bottom") +
  labs(x = "Time (yrs)", y = "Annual mass (Metric Mtons)") +
  facet_wrap(~class, ncol = 2) +
  scale_y_continuous(label = comma)

ggsave("results/p_salt_budget.pdf", p3, height= 4, width = 7, device = cairo_pdf)
```


# GIF for github
```{r}
# mean TDS
TDS_mean = as.data.frame(matrix(0,8,8))
for(i in 1:8){
  for(j in 1:8){
    TDS_mean[i,j] = mean(TDS[i,j,])
  }
}

# mean depths
sd.top = matrix(0,7,8)
sd.bottom = matrix(0,7,8)
for(d in 1:7){
  for(t in 1:8){
    sd.top[d,t] = TDS_mean[d,t] - sd(TDS[d,t,]) # sd
    sd.bottom[d,t] = TDS_mean[d,t] + sd(TDS[d,t,]) # sd
  }
}

# 5th and 95th percentiles
TDS_5 = matrix(0,7,8)
TDS_95 = matrix(0,7,8)
for(d in 1:7){
  for(t in 1:8){
    TDS_5[d,t] = quantile(TDS[d,t,], c(0.05)) # 5% CI
    TDS_95[d,t] = quantile(TDS[d,t,], c(.95))  # 95% CI
  }
}

## calculate layer depths/velocities of simulation means for main plot
layer_depths_mean = as.data.frame(matrix(0,7,1))
layer_velocity_mean = as.data.frame(matrix(0,7,1))
for(j in 1:7){
  layer_depths_mean[j,1] = mean(layer_depths_array[j,1,]) * -1
  layer_velocity_mean[j,1] = mean(layer_velocity_array[j,1,])
}

## reshape layer_depths_mean for plotting
layer_depths_mean = t.default(layer_depths_mean)

## trim 8th layer of TDS_mean matrix for plotting
TDS_mean = TDS_mean[1:7,]


# compile into one df
pl = data.frame(depth = layer_depths_mean, TDS1 = TDS_mean[,1], TDS2 = TDS_mean[,2],
                TDS3 = TDS_mean[,3], TDS4 = TDS_mean[,4], TDS5 = TDS_mean[,5],
                TDS6 = TDS_mean[,6], TDS7 = TDS_mean[,7], TDS8 = TDS_mean[,8],
                U1 = TDS_95[,1], L1 = TDS_5[,1],
                U2 = TDS_95[,2], L2 = TDS_5[,2],
                U3 = TDS_95[,3], L3 = TDS_5[,3],
                U4 = TDS_95[,4], L4 = TDS_5[,4],
                U5 = TDS_95[,5], L5 = TDS_5[,5],
                U6 = TDS_95[,6], L6 = TDS_5[,6],
                U7 = TDS_95[,7], L7 = TDS_5[,7],
                U8 = TDS_95[,8], L8 = TDS_5[,8])

# make gif
library(gganimate)
temp <- select(pl, depth, TDS1:TDS8)
temp2 <- tidyr::gather(temp, key, value, - depth)

# data reshaping
temp2 <- temp2 %>% 
  mutate(t = as.numeric(substr(key, 4, 5))) 
temp3 <- select(pl, depth, starts_with("U")) %>%
  tidyr::gather(key, value, - depth) %>% 
  mutate(t = as.numeric(substr(key, 2, 3))) %>% 
  rename(p95 = value) %>% 
  select(-key)
temp4 <- select(pl, depth, starts_with("L")) %>% 
  tidyr::gather(key, value, - depth) %>% 
  mutate(t = as.numeric(substr(key, 2, 3))) %>% 
  rename(p5 = value) %>% 
  select(-key)
temp5 <- left_join(temp3, temp4, by = c("depth", "t")) 
temp6 <- left_join(temp5, temp2, by = c("depth", "t"))

temp6$depth <- temp6$depth * 0.3048 # convert depth to m
temp6$t     <- rep(seq(0, 350, 50), each = 7) # time from index to years

# make the animation
anim <- ggplot(temp6, aes(depth, value)) + 
  geom_ribbon(aes(ymin = p5, ymax = p95), alpha = 0.4) +
  geom_line(col = "red", size = 1) + 
  coord_flip() +
  theme_minimal(base_size = 14) +
  labs(title = 'Time: {round(frame_time, 2)} yrs ({1960 + round(frame_time, 0)})', 
       y = "TDS (mg/L)", x = "Depth (m)") + 
  transition_time(t) + 
  ease_aes("linear")

anim_save("salinization.gif", anim) # save to root
```



